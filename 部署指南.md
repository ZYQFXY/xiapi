# xiapi 服务部署指南

## 一、服务器环境准备

### 1. 安装 Node.js（推荐 v18 或更高版本）

```bash
# 使用 nvm 安装（推荐）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18

# 或者直接安装
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

### 2. 安装 PM2

```bash
npm install -g pm2
```

### 3. 安装 Git（如果需要）

```bash
sudo apt-get update
sudo apt-get install -y git
```

## 二、部署步骤

### 1. 上传代码到服务器

**方式一：使用 Git**
```bash
cd /home/your-username
git clone <你的仓库地址>
cd xiapi
```

**方式二：手动上传**
使用 FTP/SFTP 工具（如 FileZilla）上传整个项目文件夹到服务器

### 2. 配置环境变量

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑环境变量（重要！）
nano .env
```

**必须配置的环境变量：**
- `UPSTREAM_TOKEN` - 上游接口 token
- `TOKEGE_TOKEN` - tokege 接口 token
- `PORT` - 服务端口（默认 3000）

### 3. 执行部署脚本

```bash
# 添加执行权限
chmod +x deploy.sh

# 运行部署脚本
bash deploy.sh
```

### 4. 设置 PM2 开机自启

```bash
# 生成启动脚本
pm2 startup

# 按照提示执行命令（通常是 sudo 开头的命令）
# 保存当前进程列表
pm2 save
```

## 三、常用管理命令

```bash
# 查看服务状态
pm2 status

# 查看实时日志
pm2 logs xiapi

# 查看最近 100 行日志
pm2 logs xiapi --lines 100

# 重启服务
pm2 restart xiapi

# 停止服务
pm2 stop xiapi

# 删除服务
pm2 delete xiapi

# 查看详细信息
pm2 show xiapi

# 监控资源使用
pm2 monit
```

## 四、配置防火墙和端口

### 开放服务端口（假设使用 3000）

```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 3000/tcp
sudo ufw reload

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload
```

### 云服务器安全组配置

在云服务商控制台添加安全组规则：
- 协议：TCP
- 端口：3000（或你配置的端口）
- 来源：0.0.0.0/0（或指定 IP）

## 五、使用 Nginx 反向代理（可选）

### 1. 安装 Nginx

```bash
sudo apt-get install -y nginx
```

### 2. 配置反向代理

```bash
sudo nano /etc/nginx/sites-available/xiapi
```

添加以下配置：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名或 IP

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 3. 启用配置

```bash
sudo ln -s /etc/nginx/sites-available/xiapi /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

## 六、日志管理

日志文件位置：
- 应用日志：`./logs/` 目录
- PM2 日志：`./logs/pm2-*.log`

清理日志：
```bash
pm2 flush  # 清空 PM2 日志
```

## 七、更新部署

```bash
# 拉取最新代码
git pull

# 重新部署
bash deploy.sh
```

## 八、故障排查

### 服务无法启动

```bash
# 查看错误日志
pm2 logs xiapi --err

# 检查环境变量
cat .env

# 手动启动测试
node src/index.js
```

### 端口被占用

```bash
# 查看端口占用
sudo lsof -i :3000

# 或者
sudo netstat -tulpn | grep 3000
```

### 内存不足

修改 `ecosystem.config.js` 中的 `max_memory_restart` 参数

## 九、安全建议

1. 不要将 `.env` 文件提交到 Git
2. 定期更新依赖：`npm update`
3. 使用 HTTPS（配置 SSL 证书）
4. 限制服务器访问 IP
5. 定期备份数据和配置

## 十、监控和告警（可选）

使用 PM2 Plus 进行监控：
```bash
pm2 link <secret_key> <public_key>
```

访问 https://app.pm2.io 查看监控数据
