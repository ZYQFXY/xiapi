# xiapi 云服务器管理手册

## 项目信息

- **项目名称**：xiapi
- **部署路径**：D:\projects\xiapi
- **运行端口**：3000（本地访问）
- **进程管理**：PM2
- **服务器系统**：Windows Server
- **远程工具**：ToDesk

---

## 一、服务管理命令

### 1.1 查看服务状态

```bash
cd D:\projects\xiapi
pm2 status
```

**输出示例：**
```
┌────┬───────┬──────┬──────┬──────────┬─────────┬─────────┐
│ id │ name  │ mode │ ↺    │ status   │ cpu     │ memory  │
├────┼───────┼──────┼──────┼──────────┼─────────┼─────────┤
│ 0  │ xiapi │ fork │ 0    │ online   │ 0%      │ 134.0mb │
└────┴───────┴──────┴──────┴──────────┴─────────┴─────────┘
```

### 1.2 查看实时日志

```bash
# 查看实时日志（Ctrl+C 退出）
pm2 logs xiapi

# 查看最近 100 行日志
pm2 logs xiapi --lines 100

# 只查看错误日志
pm2 logs xiapi --err

# 清空日志
pm2 flush
```

### 1.3 重启服务

```bash
# 重启服务
pm2 restart xiapi

# 重新加载配置并重启
pm2 reload xiapi

# 停止服务
pm2 stop xiapi

# 启动服务
pm2 start xiapi
```

### 1.4 删除服务

```bash
# 删除服务（需要重新部署才能启动）
pm2 delete xiapi

# 删除所有服务
pm2 delete all
```

### 1.5 监控服务

```bash
# 实时监控（CPU、内存使用情况）
pm2 monit

# 查看详细信息
pm2 show xiapi
```

---

## 二、日常维护

### 2.1 修改配置文件

```bash
cd D:\projects\xiapi

# 编辑环境变量
notepad .env

# 修改后重启服务
pm2 restart xiapi
```

**常用配置项：**
- `PORT` - 服务端口
- `UPSTREAM_TOKEN` - 上游接口 token
- `TOKEGE_TOKEN` - tokege 接口 token
- `LOG_LEVEL` - 日志级别（info/debug/error）
- `PULL_INTERVAL` - 拉取间隔（毫秒）
- `QUERY_CONCURRENCY` - 查询并发数

### 2.2 查看日志文件

**应用日志位置：**
```
D:\projects\xiapi\logs\
```

**PM2 日志位置：**
```
C:\Users\Administrator\.pm2\logs\
```

**查看日志：**
```bash
# 使用记事本打开
notepad D:\projects\xiapi\logs\app.log

# 或使用 type 命令查看
type D:\projects\xiapi\logs\app.log
```

### 2.3 清理日志

```bash
# 清空 PM2 日志
pm2 flush

# 手动删除应用日志
del D:\projects\xiapi\logs\*.log
```

---

## 三、更新部署

### 3.1 更新代码

**方法一：直接复制文件**
1. 在本地修改代码
2. 通过 ToDesk 复制文件到服务器覆盖
3. 重启服务

```bash
cd D:\projects\xiapi
pm2 restart xiapi
```

**方法二：使用 Git（如果配置了 Git）**
```bash
cd D:\projects\xiapi
git pull
npm install --production
pm2 restart xiapi
```

### 3.2 更新依赖

```bash
cd D:\projects\xiapi

# 更新所有依赖
npm update

# 安装新依赖
npm install

# 重启服务
pm2 restart xiapi
```

---

## 四、故障排查

### 4.1 服务无法启动

```bash
# 查看错误日志
pm2 logs xiapi --err

# 手动启动测试
cd D:\projects\xiapi
node src/index.js
```

**常见问题：**
- 检查 `.env` 文件是否配置正确
- 检查端口是否被占用
- 检查依赖是否安装完整

### 4.2 端口被占用

```bash
# 查看端口占用
netstat -ano | findstr :3000

# 结束占用进程（PID 从上面命令获取）
taskkill /PID <进程ID> /F
```

### 4.3 内存占用过高

```bash
# 查看内存使用
pm2 status

# 重启服务释放内存
pm2 restart xiapi
```

**修改内存限制：**
编辑 `ecosystem.config.js`，修改 `max_memory_restart` 参数：
```javascript
max_memory_restart: '500M'  // 超过 500MB 自动重启
```

### 4.4 服务频繁重启

```bash
# 查看重启次数（↺ 列）
pm2 status

# 查看错误日志
pm2 logs xiapi --err
```

**可能原因：**
- 代码错误导致崩溃
- 内存不足
- 依赖缺失

---

## 五、性能优化

### 5.1 调整并发参数

编辑 `.env` 文件：
```bash
# 查询并发数（根据服务器性能调整）
QUERY_CONCURRENCY=50

# 回调并发数
CALLBACK_CONCURRENCY=20

# 拉取间隔（毫秒）
PULL_INTERVAL=2000
```

### 5.2 日志级别

```bash
# 生产环境建议使用 info 或 warn
LOG_LEVEL=info

# 调试时使用 debug
LOG_LEVEL=debug
```

---

## 六、备份与恢复

### 6.1 备份配置

```bash
# 备份环境变量
copy D:\projects\xiapi\.env D:\backup\.env.backup

# 备份整个项目（不包括 node_modules）
xcopy D:\projects\xiapi D:\backup\xiapi /E /I /EXCLUDE:node_modules
```

### 6.2 恢复配置

```bash
# 恢复环境变量
copy D:\backup\.env.backup D:\projects\xiapi\.env

# 重启服务
pm2 restart xiapi
```

---

## 七、开机自启

### 7.1 验证自启配置

```bash
# 查看 PM2 启动配置
pm2 startup

# 保存当前进程列表
pm2 save
```

### 7.2 测试自启

1. 重启服务器
2. 登录后执行：
```bash
pm2 status
```
3. 确认 xiapi 服务状态为 online

---

## 八、安全建议

### 8.1 保护敏感信息

- ❌ 不要将 `.env` 文件分享给他人
- ❌ 不要将 token 写在代码中
- ✅ 定期更换 token
- ✅ 使用强密码保护服务器

### 8.2 定期维护

- 每周查看日志，检查异常
- 每月更新依赖包
- 定期备份配置文件
- 监控服务器资源使用情况

---

## 九、常见操作速查

| 操作 | 命令 |
|------|------|
| 查看状态 | `pm2 status` |
| 查看日志 | `pm2 logs xiapi` |
| 重启服务 | `pm2 restart xiapi` |
| 停止服务 | `pm2 stop xiapi` |
| 启动服务 | `pm2 start xiapi` |
| 实时监控 | `pm2 monit` |
| 清空日志 | `pm2 flush` |
| 保存配置 | `pm2 save` |

---

## 十、联系方式

**遇到问题时：**
1. 查看日志：`pm2 logs xiapi --err`
2. 检查配置：`notepad .env`
3. 重启服务：`pm2 restart xiapi`
4. 手动测试：`node src/index.js`

**项目文件结构：**
```
D:\projects\xiapi\
├── src/                    # 源代码
│   ├── index.js           # 入口文件
│   ├── config.js          # 配置文件
│   ├── api/               # API 路由
│   ├── services/          # 业务逻辑
│   ├── scheduler/         # 调度器
│   └── utils/             # 工具函数
├── logs/                  # 日志目录
├── node_modules/          # 依赖包
├── .env                   # 环境变量（敏感信息）
├── .env.example           # 环境变量模板
├── ecosystem.config.js    # PM2 配置
└── package.json           # 项目配置
```

---

**最后更新：2026-02-14**
