<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>虾皮数据服务控制台 - 2号客户接口1</title>
<link rel="icon" href="data:,">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f1923; color: #e0e0e0; min-height: 100vh; }

/* 顶部标题栏 */
.header { background: #1a2a3a; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #2d4a5e; }
.header h1 { font-size: 18px; color: #4fc3f7; }
.header-right { display: flex; gap: 20px; font-size: 13px; color: #90a4ae; }
.status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }
.status-dot.connected { background: #4caf50; }
.status-dot.disconnected { background: #f44336; }

/* 指标卡片 */
.metrics { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; padding: 12px 24px; }
.metric-card { background: #1a2a3a; border-radius: 8px; padding: 10px; border-left: 4px solid; }
.metric-card.green { border-color: #4caf50; }
.metric-card.blue { border-color: #2196f3; }
.metric-card.red { border-color: #f44336; }
.metric-card.orange { border-color: #ff9800; }
.metric-card.purple { border-color: #ab47bc; }
.metric-card .label { font-size: 12px; color: #90a4ae; margin-bottom: 4px; }
.metric-card .value { font-size: 22px; font-weight: bold; }
.metric-card .sub-value { font-size: 12px; color: #90a4ae; margin-top: 2px; }
.metric-card.green .value { color: #4caf50; }
.metric-card.blue .value { color: #2196f3; }
.metric-card.red .value { color: #f44336; }
.metric-card.orange .value { color: #ff9800; }
.metric-card.orange .sub-value { color: #ffb74d; }
.metric-card.purple .value { color: #ce93d8; }

/* 统计面板 */
.panels { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding: 0 24px 16px; }
.panel { background: #1a2a3a; border-radius: 8px; padding: 10px; }
.panel h3 { font-size: 13px; color: #4fc3f7; margin-bottom: 6px; border-bottom: 1px solid #2d4a5e; padding-bottom: 4px; }
.panel h3 .rate-value { float: right; font-size: 13px; color: #ff9800; font-weight: bold; }
.stat-row { display: flex; justify-content: space-between; padding: 2px 0; font-size: 12px; }
.stat-row .stat-label { color: #90a4ae; }
.stat-row .stat-value { color: #e0e0e0; font-family: 'Consolas', monospace; }

/* 控制按钮 */
.controls { padding: 0 24px 16px; display: flex; gap: 12px; align-items: center; }
.controls .label { font-size: 13px; color: #90a4ae; margin-right: 8px; }
.btn { padding: 8px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: opacity 0.2s; }
.btn:hover { opacity: 0.85; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-start { background: #4caf50; color: #fff; }
.btn-stop { background: #f44336; color: #fff; }
.btn-pull-start { background: #2196f3; color: #fff; }
.btn-pull-stop { background: #ff9800; color: #fff; }
.scheduler-status { font-size: 13px; margin-left: 12px; padding: 4px 12px; border-radius: 4px; }
.scheduler-status.running { background: rgba(76,175,80,0.2); color: #4caf50; }
.scheduler-status.stopped { background: rgba(244,67,54,0.2); color: #f44336; }
.scheduler-status.sleeping { background: rgba(255,152,0,0.2); color: #ff9800; }
.scheduler-status.credit-exhausted { background: rgba(156,39,176,0.2); color: #ce93d8; }

/* 系统状态栏 */
.status-bar { padding: 0 24px 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.status-bar .label { font-size: 13px; color: #90a4ae; margin-right: 4px; }
.status-badge { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 4px 12px; border-radius: 4px; font-weight: 500; }
.status-badge .badge-label { color: #90a4ae; }
.status-badge.normal { background: rgba(76,175,80,0.15); color: #4caf50; }
.status-badge.degraded { background: rgba(255,152,0,0.2); color: #ff9800; }
.status-badge.circuit-break { background: rgba(244,67,54,0.2); color: #f44336; }
.status-badge.exhausted { background: rgba(156,39,176,0.2); color: #ce93d8; }
.status-badge.backpressure { background: rgba(255,152,0,0.2); color: #ff9800; }

/* 任务日志三面板 */
.task-logs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 0 24px 16px; }
.task-log-panel { background: #1a2a3a; border-radius: 8px; padding: 8px; }
.task-log-panel h3 { font-size: 13px; color: #4fc3f7; margin-bottom: 4px; border-bottom: 1px solid #2d4a5e; padding-bottom: 4px; }
.task-log-box { background: #0a1520; border-radius: 6px; padding: 6px; height: 120px; overflow-y: auto; font-family: 'Consolas', 'Courier New', monospace; font-size: 12px; line-height: 1.5; border: 1px solid #1a2a3a; }
.tl { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.tl .ts { color: #607d8b; }
.tl.ok .st { color: #ef5350; font-weight: bold; }
.tl.fail .st { color: #66bb6a; font-weight: bold; }
.tl .id { color: #90a4ae; }

/* 系统日志（折叠） */
.sys-log-section { padding: 0 24px 24px; }
.sys-log-toggle { font-size: 13px; color: #607d8b; cursor: pointer; user-select: none; }
.sys-log-toggle:hover { color: #90a4ae; }
.sys-log-box { background: #0a1520; border-radius: 8px; padding: 12px; height: 200px; overflow-y: auto; font-family: 'Consolas', 'Courier New', monospace; font-size: 11px; line-height: 1.5; border: 1px solid #1a2a3a; display: none; margin-top: 8px; }
.sys-log-box.open { display: block; }
.sl { white-space: pre-wrap; word-break: break-all; color: #607d8b; }
.sl.err { color: #ef5350; }
.sl.wrn { color: #ffa726; }
</style>
</head>
<body>

<div class="header">
  <h1>虾皮数据服务控制台 - 2号客户接口1</h1>
  <div class="header-right">
    <span>运行时间: <span id="uptime">--</span></span>
    <span><span class="status-dot disconnected" id="connDot"></span><span id="connText">未连接</span></span>
  </div>
</div>

<div class="metrics">
  <div class="metric-card green">
    <div class="label">回调成功数</div>
    <div class="value" id="m-callback-success">0</div>
  </div>
  <div class="metric-card blue">
    <div class="label">队列长度</div>
    <div class="value" id="m-queue-length">0</div>
  </div>
  <div class="metric-card green">
    <div class="label">成功任务数</div>
    <div class="value" id="m-query-success">0</div>
  </div>
  <div class="metric-card red">
    <div class="label">废弃任务数</div>
    <div class="value" id="m-dropped">0</div>
  </div>
  <div class="metric-card orange">
    <div class="label">当天任务量</div>
    <div class="value" id="m-curnum">0</div>
    <div class="sub-value">本次新增: <span id="m-curnum-inc">+0</span></div>
  </div>
  <div class="metric-card purple">
    <div class="label">API 余额</div>
    <div class="value" id="m-credits">--</div>
    <div class="sub-value">本次消耗: <span id="m-credits-consumed">0</span></div>
  </div>
</div>

<div class="panels">
  <div class="panel">
    <h3>数据请求统计 <span class="rate-value" id="s-query-rate">0</span> 条/分</h3>
    <div class="stat-row"><span class="stat-label">总请求数</span><span class="stat-value" id="s-total-requests">0</span></div>
    <div class="stat-row"><span class="stat-label">查询成功</span><span class="stat-value" id="s-query-success">0</span></div>
    <div class="stat-row"><span class="stat-label">查询失败(重试)</span><span class="stat-value" id="s-query-failure">0</span></div>
    <div class="stat-row"><span class="stat-label">商品下架</span><span class="stat-value" id="s-offline">0</span></div>
    <div class="stat-row"><span class="stat-label">商品处理中</span><span class="stat-value" id="s-processing">0</span></div>
    <div class="stat-row"><span class="stat-label">额度耗尽</span><span class="stat-value" id="s-credit-exhausted">0</span></div>
  </div>
  <div class="panel">
    <h3>客户接口统计 <span class="rate-value" id="s-callback-rate">0</span> 条/分</h3>
    <div class="stat-row"><span class="stat-label">回调成功总数</span><span class="stat-value" id="s-cb-success">0</span></div>
    <div class="stat-row"><span class="stat-label">废弃任务数</span><span class="stat-value" id="s-cb-dropped">0</span></div>
    <div class="stat-row"><span class="stat-label">重试队列长度</span><span class="stat-value" id="s-retry-queue">0</span></div>
    <div class="stat-row"><span class="stat-label">拉取总数</span><span class="stat-value" id="s-pull-total">0</span></div>
    <div class="stat-row"><span class="stat-label">拉取过期丢弃</span><span class="stat-value" id="s-pull-expired">0</span></div>
  </div>
  <div class="panel">
    <h3>队列状态 <span class="rate-value" id="s-pull-rate">0</span> 条/分</h3>
    <div class="stat-row"><span class="stat-label">待处理任务</span><span class="stat-value" id="s-q-pending">0</span></div>
    <div class="stat-row"><span class="stat-label">在途去重键</span><span class="stat-value" id="s-q-dedupe">0</span></div>
    <div class="stat-row"><span class="stat-label">已处理(永久去重)</span><span class="stat-value" id="s-q-processed">0</span></div>
    <div class="stat-row"><span class="stat-label">拉取去重(丢弃)</span><span class="stat-value" id="s-pull-dup">0</span></div>
    <div class="stat-row"><span class="stat-label">超时丢弃</span><span class="stat-value" id="s-query-skip">0</span></div>
    <div class="stat-row"><span class="stat-label">查询前过期</span><span class="stat-value" id="s-query-stale">0</span></div>
    <div class="stat-row"><span class="stat-label">队列中超时</span><span class="stat-value" id="s-queue-timeout">0</span></div>
    <div class="stat-row"><span class="stat-label">回调队列</span><span class="stat-value" id="s-cb-queue">0</span></div>
    <div class="stat-row"><span class="stat-label">工作线程(拉/查/回)</span><span class="stat-value" id="s-workers">0/0/0</span></div>
  </div>
</div>

<div class="controls">
  <span class="label">调度器控制:</span>
  <button class="btn btn-start" id="btn-start" onclick="sendCmd('startScheduler')">启动任务</button>
  <button class="btn btn-stop" id="btn-stop" onclick="sendCmd('stopScheduler')">停止任务</button>
  <button class="btn btn-pull-start" id="btn-pull-start" onclick="sendCmd('startPulling')">启动拉取</button>
  <button class="btn btn-pull-stop" id="btn-pull-stop" onclick="sendCmd('stopPulling')">停止拉取</button>
  <button class="btn btn-stop" id="btn-shutdown" onclick="shutdownService()">终止服务</button>
  <span class="scheduler-status stopped" id="scheduler-status">已停止</span>
</div>

<div class="status-bar">
  <span class="label">系统状态:</span>
  <span class="status-badge normal" id="sb-pull"><span class="badge-label">拉取</span> 正常</span>
  <span class="status-badge normal" id="sb-query"><span class="badge-label">查询</span> 正常</span>
  <span class="status-badge normal" id="sb-callback"><span class="badge-label">回调</span> 正常</span>
  <span class="status-badge normal" id="sb-backpressure"><span class="badge-label">背压</span> 正常</span>
  <span class="status-badge normal" id="sb-credit"><span class="badge-label">额度</span> 正常</span>
</div>

<div class="task-logs">
  <div class="task-log-panel">
    <h3>拉取任务</h3>
    <div class="task-log-box" id="tl-pull"></div>
  </div>
  <div class="task-log-panel">
    <h3>查询任务</h3>
    <div class="task-log-box" id="tl-query"></div>
  </div>
  <div class="task-log-panel">
    <h3>回调任务</h3>
    <div class="task-log-box" id="tl-callback"></div>
  </div>
</div>

<div class="sys-log-section">
  <span class="sys-log-toggle" id="sys-toggle" onclick="toggleSysLog()">&#9654; 系统日志</span>
  <div class="sys-log-box" id="sys-log"></div>
</div>

<script>
var ws = null;
var startTime = Date.now();
var reconnectTimer = null;
var reconnectDelay = 1000;
var connecting = false;

var pendingStats = null;
var pendingSysLogs = [];
var pendingTaskLogs = { pull: [], query: [], callback: [] };
var rafId = null;
var MAX_LINES = 150;

// 去重追踪：防止重连时日志重复
var lastTaskLogTs = { pull: 0, query: 0, callback: 0 };
var processedSysLogs = {};
var processedSysLogCount = 0;
var MAX_PROCESSED_LOGS = 300;

function $(id) { return document.getElementById(id); }

function pad2(n) { return n < 10 ? '0' + n : '' + n; }

function formatUptime(ms) {
  var s = Math.floor(ms / 1000);
  var h = Math.floor(s / 3600);
  var m = Math.floor((s % 3600) / 60);
  var sec = s % 60;
  return (h > 0 ? h + 'h ' : '') + m + 'm ' + sec + 's';
}

function formatTs(ts) {
  var d = new Date(ts);
  return pad2(d.getHours()) + ':' + pad2(d.getMinutes()) + ':' + pad2(d.getSeconds());
}

setInterval(function() {
  $('uptime').textContent = formatUptime(Date.now() - startTime);
}, 1000);

function setConnected(connected) {
  var dot = $('connDot');
  var text = $('connText');
  if (connected) {
    dot.className = 'status-dot connected';
    text.textContent = '已连接';
  } else {
    dot.className = 'status-dot disconnected';
    text.textContent = '未连接';
  }
}

function updateStats(data) {
  $('m-callback-success').textContent = data.callbackSuccess || 0;
  $('m-queue-length').textContent = data.queuePending || 0;
  $('m-query-success').textContent = (data.queryStats ? (data.queryStats.successCount || 0) + (data.queryStats.offlineCount || 0) : 0);
  $('m-dropped').textContent = data.callbackDropped || 0;

  if (data.curnumData) {
    $('m-curnum').textContent = data.curnumData.current || 0;
    $('m-curnum-inc').textContent = '+' + (data.curnumData.sessionIncrement || 0);
  }

  if (data.tokegeCredits !== null && data.tokegeCredits !== undefined) {
    $('m-credits').textContent = data.tokegeCredits.toLocaleString();
    $('m-credits-consumed').textContent = (data.tokegeCreditsConsumed || 0).toLocaleString();
  }

  if (data.queryStats) {
    $('s-total-requests').textContent = data.queryStats.totalRequests || 0;
    $('s-query-success').textContent = (data.queryStats.successCount || 0) + (data.queryStats.offlineCount || 0);
    $('s-query-failure').textContent = data.queryStats.failureCount || 0;
    $('s-offline').textContent = data.queryStats.offlineCount || 0;
    $('s-processing').textContent = data.queryStats.processingCount || 0;
    $('s-credit-exhausted').textContent = data.queryStats.creditExhaustedCount || 0;
    $('s-query-rate').textContent = data.queryStats.queryRatePerMin || 0;
  }

  $('s-cb-success').textContent = data.callbackSuccess || 0;
  $('s-cb-dropped').textContent = data.callbackDropped || 0;
  $('s-retry-queue').textContent = data.retryQueueLength || 0;
  $('s-callback-rate').textContent = data.callbackRatePerMin || 0;

  if (data.pullStats) {
    $('s-pull-total').textContent = data.pullStats.totalPulled || 0;
    $('s-pull-expired').textContent = data.pullStats.pullExpired || 0;
    $('s-pull-rate').textContent = data.pullStats.pullRatePerMin || 0;
  }

  if (data.queueStats) {
    $('s-q-pending').textContent = data.queueStats.pending || 0;
    $('s-q-dedupe').textContent = data.queueStats.dedupeKeys || 0;
    $('s-q-processed').textContent = data.queueStats.processedKeys || 0;
  }

  if (data.schedulerStats) {
    $('s-pull-dup').textContent = data.schedulerStats.pullDupCount || 0;
    $('s-query-skip').textContent = data.schedulerStats.querySkipCount || 0;
    $('s-query-stale').textContent = data.schedulerStats.queryStaleCount || 0;
    $('s-queue-timeout').textContent = data.schedulerStats.queueTimeoutCount || 0;
    $('s-cb-queue').textContent = data.schedulerStats.callbackQueueLength || 0;
    $('s-workers').textContent = (data.schedulerStats.activePullWorkers || 0) + '/' + (data.schedulerStats.activeQueryWorkers || 0) + '/' + (data.schedulerStats.activeCallbackWorkers || 0);
  }

  var statusEl = $('scheduler-status');
  if (data.schedulerStats && data.schedulerStats.hardStopped) {
    statusEl.className = 'scheduler-status stopped';
    statusEl.textContent = '紧急停止';
  } else if (data.schedulerStats && data.schedulerStats.creditExhausted) {
    statusEl.className = 'scheduler-status credit-exhausted';
    statusEl.textContent = '额度耗尽';
  } else if (data.schedulerStats && data.schedulerStats.autoPaused) {
    statusEl.className = 'scheduler-status sleeping';
    statusEl.textContent = '背压暂停';
  } else if (data.schedulerStats && data.schedulerStats.pullingPaused) {
    statusEl.className = 'scheduler-status sleeping';
    statusEl.textContent = '拉取已暂停';
  } else if (data.schedulerRunning) {
    statusEl.className = 'scheduler-status running';
    statusEl.textContent = '运行中';
  } else {
    statusEl.className = 'scheduler-status stopped';
    statusEl.textContent = '已停止';
  }

  $('btn-start').disabled = data.schedulerRunning;
  $('btn-stop').disabled = !data.schedulerRunning;
  var isPaused = data.schedulerStats && (data.schedulerStats.pullingPaused || data.schedulerStats.autoPaused || data.schedulerStats.hardStopped);
  $('btn-pull-start').disabled = !data.schedulerRunning || !isPaused;
  $('btn-pull-stop').disabled = !data.schedulerRunning || !!isPaused;

  // 系统状态栏
  if (data.schedulerStats) {
    updateBadge('sb-pull', data.schedulerStats.pullMode);
    updateBadge('sb-query', data.schedulerStats.queryMode);
    updateBadge('sb-callback', data.schedulerStats.callbackMode);

    var bpEl = $('sb-backpressure');
    if (data.schedulerStats.autoPaused) {
      bpEl.className = 'status-badge backpressure';
      bpEl.innerHTML = '<span class="badge-label">背压</span> 暂停';
    } else {
      bpEl.className = 'status-badge normal';
      bpEl.innerHTML = '<span class="badge-label">背压</span> 正常';
    }

    var crEl = $('sb-credit');
    if (data.schedulerStats.creditExhausted) {
      crEl.className = 'status-badge exhausted';
      crEl.innerHTML = '<span class="badge-label">额度</span> 耗尽';
    } else {
      crEl.className = 'status-badge normal';
      crEl.innerHTML = '<span class="badge-label">额度</span> 正常';
    }
  }
}

function updateBadge(id, mode) {
  var el = $(id);
  var label = el.querySelector('.badge-label').textContent;
  if (mode === '熔断') {
    el.className = 'status-badge circuit-break';
    el.innerHTML = '<span class="badge-label">' + label + '</span> 熔断';
  } else if (mode === '降级') {
    el.className = 'status-badge degraded';
    el.innerHTML = '<span class="badge-label">' + label + '</span> 降级';
  } else if (mode === '额度耗尽') {
    el.className = 'status-badge exhausted';
    el.innerHTML = '<span class="badge-label">' + label + '</span> 额度耗尽';
  } else {
    el.className = 'status-badge normal';
    el.innerHTML = '<span class="badge-label">' + label + '</span> 正常';
  }
}

// ======== 任务日志渲染 ========
function renderTaskLogEntry(entry) {
  var div = document.createElement('div');
  div.className = 'tl ' + (entry.ok ? 'ok' : 'fail');
  var html = '<span class="ts">' + formatTs(entry.ts) + '</span> ';
  html += '<span class="st">' + (entry.ok ? '成功' : '失败') + '</span>';
  if (entry.sid) {
    html += ' <span class="id">' + entry.sid;
    if (entry.iid) html += ' ' + entry.iid;
    html += '</span>';
  }
  div.innerHTML = html;
  return div;
}

function flushTaskLogs(containerId, entries) {
  var box = $(containerId);
  var atBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 20;

  var frag = document.createDocumentFragment();
  for (var i = 0; i < entries.length; i++) {
    frag.appendChild(renderTaskLogEntry(entries[i]));
  }
  box.appendChild(frag);

  var overflow = box.children.length - MAX_LINES;
  if (overflow > 0) {
    var range = document.createRange();
    range.setStartBefore(box.firstChild);
    range.setEndAfter(box.children[overflow - 1]);
    range.deleteContents();
  }

  if (atBottom) box.scrollTop = box.scrollHeight;
}

// ======== 系统日志（可折叠）========
var sysLogOpen = false;
function toggleSysLog() {
  sysLogOpen = !sysLogOpen;
  var box = $('sys-log');
  var toggle = $('sys-toggle');
  if (sysLogOpen) {
    box.className = 'sys-log-box open';
    toggle.innerHTML = '&#9660; 系统日志';
  } else {
    box.className = 'sys-log-box';
    toggle.innerHTML = '&#9654; 系统日志';
  }
}

function flushSysLogs(logs) {
  var box = $('sys-log');
  var atBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 20;

  var frag = document.createDocumentFragment();
  for (var i = 0; i < logs.length; i++) {
    var div = document.createElement('div');
    var cls = 'sl';
    if (logs[i].indexOf('[ERROR]') !== -1) cls += ' err';
    else if (logs[i].indexOf('[WARN]') !== -1) cls += ' wrn';
    div.className = cls;
    div.textContent = logs[i];
    frag.appendChild(div);
  }
  box.appendChild(frag);

  var overflow = box.children.length - MAX_LINES;
  if (overflow > 0) {
    var range = document.createRange();
    range.setStartBefore(box.firstChild);
    range.setEndAfter(box.children[overflow - 1]);
    range.deleteContents();
  }

  if (atBottom) box.scrollTop = box.scrollHeight;
}

// ======== rAF 统一渲染 ========
function scheduleRender() {
  if (rafId) return;
  rafId = requestAnimationFrame(function() {
    rafId = null;
    if (pendingStats) {
      updateStats(pendingStats);
      pendingStats = null;
    }
    if (pendingTaskLogs.pull.length) { flushTaskLogs('tl-pull', pendingTaskLogs.pull); pendingTaskLogs.pull = []; }
    if (pendingTaskLogs.query.length) { flushTaskLogs('tl-query', pendingTaskLogs.query); pendingTaskLogs.query = []; }
    if (pendingTaskLogs.callback.length) { flushTaskLogs('tl-callback', pendingTaskLogs.callback); pendingTaskLogs.callback = []; }
    if (pendingSysLogs.length) { flushSysLogs(pendingSysLogs); pendingSysLogs = []; }
  });
}

function bufferTaskLogs(data) {
  var channels = ['pull', 'query', 'callback'];
  for (var c = 0; c < channels.length; c++) {
    var ch = channels[c];
    if (data[ch] && data[ch].length) {
      for (var i = 0; i < data[ch].length; i++) {
        var entry = data[ch][i];
        // 按时间戳去重，跳过重连时服务端重复推送的旧日志
        if (entry.ts && entry.ts <= lastTaskLogTs[ch]) continue;
        pendingTaskLogs[ch].push(entry);
        if (entry.ts) lastTaskLogTs[ch] = entry.ts;
      }
      if (pendingTaskLogs[ch].length > MAX_LINES) {
        pendingTaskLogs[ch] = pendingTaskLogs[ch].slice(-MAX_LINES);
      }
    }
  }
}

// ======== WebSocket 连接 ========
var lastMessageTime = 0;       // 上次收到消息的时间戳
var STALE_TIMEOUT = 5000;      // 5秒没收到消息判定连接失效（服务端每秒推送）
var watchdogTimer = null;

function sendCmd(cmd) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'command', command: cmd }));
  }
}

function shutdownService() {
  if (!confirm('确定要终止服务吗？服务将完全停止，需要手动重启。')) return;
  sendCmd('shutdown');
  setConnected(false);
  $('connText').textContent = '服务已终止';
}

function forceReconnect() {
  if (ws) {
    try { ws.onclose = null; ws.onerror = null; ws.close(); } catch (e) {}
    ws = null;
  }
  connecting = false;
  setConnected(false);
  reconnectDelay = 1000;
  if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
  connect();
}

function connect() {
  if (connecting) return;
  if (ws && ws.readyState === WebSocket.OPEN) return;
  connecting = true;

  if (ws) {
    try { ws.onclose = null; ws.onerror = null; ws.close(); } catch (e) {}
    ws = null;
  }

  try {
    var protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(protocol + '//' + location.host + '/ws');
  } catch (e) {
    connecting = false;
    setConnected(false);
    scheduleReconnect();
    return;
  }

  ws.onopen = function() {
    connecting = false;
    reconnectDelay = 1000;
    lastMessageTime = Date.now();
    setConnected(true);
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
  };

  ws.onmessage = function(e) {
    lastMessageTime = Date.now();
    try {
      var msg = JSON.parse(e.data);
      if (msg.type === 'stats') {
        pendingStats = msg.data;
      } else if (msg.type === 'taskLogs') {
        bufferTaskLogs(msg.data);
      } else if (msg.type === 'logs') {
        for (var i = 0; i < msg.data.length; i++) {
          var logLine = msg.data[i];
          if (processedSysLogs[logLine]) continue; // 跳过已处理的重复日志
          processedSysLogs[logLine] = 1;
          processedSysLogCount++;
          pendingSysLogs.push(logLine);
        }
        // 防止去重表无限增长
        if (processedSysLogCount > MAX_PROCESSED_LOGS) {
          processedSysLogs = {};
          processedSysLogCount = 0;
        }
        if (pendingSysLogs.length > MAX_LINES) pendingSysLogs = pendingSysLogs.slice(-MAX_LINES);
      }
      scheduleRender();
    } catch (err) {}
  };

  ws.onclose = function() {
    connecting = false;
    setConnected(false);
    scheduleReconnect();
  };

  ws.onerror = function() {
    connecting = false;
    setConnected(false);
    scheduleReconnect();
  };
}

function scheduleReconnect() {
  if (reconnectTimer) return;
  reconnectTimer = setTimeout(function() {
    reconnectTimer = null;
    connect();
  }, reconnectDelay);
  reconnectDelay = Math.min(reconnectDelay * 1.5, 10000);
}

// 客户端看门狗：每3秒检查是否长时间没收到消息
watchdogTimer = setInterval(function() {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  if (lastMessageTime > 0 && (Date.now() - lastMessageTime) > STALE_TIMEOUT) {
    forceReconnect();
  }
}, 3000);

// 页面可见性变化：标签页从后台切回时立即检测并重连
document.addEventListener('visibilitychange', function() {
  if (document.hidden) return;
  // 页面变为可见，检查连接状态
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    // 连接已断，立即重连
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
    reconnectDelay = 1000;
    connecting = false;
    connect();
  } else if (lastMessageTime > 0 && (Date.now() - lastMessageTime) > STALE_TIMEOUT) {
    // 连接看似在但已经静默死亡
    forceReconnect();
  }
});

// 网络恢复时立即重连
window.addEventListener('online', function() {
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
    reconnectDelay = 1000;
    connecting = false;
    connect();
  }
});

connect();
</script>
</body>
</html>
